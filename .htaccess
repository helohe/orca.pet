Options -Includes
RewriteEngine On

# Rewrite to root Tor
RewriteCond %{HTTP_HOST} \.orca4pet7uu5puvs\.onion$
RewriteRule ^(.*) http://orca4pet7uu5puvs.onion$1 [L,R=301]

# Rewrite to main page
RewriteCond %{HTTP_HOST} !^orca\.pet$
RewriteCond %{HTTP_HOST} !^orca4pet7uu5puvs\.onion$
RewriteRule ^(.*) https://orca.pet$1 [L,R=301]

# Rewrite to HTTPS if using plain internet
RewriteCond %{HTTP_HOST} ^orca\.pet$
RewriteCond %{HTTPS} !=on
RewriteRule ^(.*) https://orca.pet$1 [L,R=301]

# Security headers
Header set Strict-Transport-Security "max-age=31536000" env=HTTPS
Header set X-Frame-Options DENY

# Add Onion-Location for HTML files
<If "%{REQUEST_FILENAME} =~ /\.html$/">
	Header set Onion-Location "expr=http://orca4pet7uu5puvs.onion%{REQUEST_URI}" env=HTTPS
</If>

# Fix minor spelling mistakes
# Yes, module is "mod_speling", not "mod_spelling"
<IfModule mod_speling.c>
	CheckCaseOnly On
	CheckSpelling On
</IfModule>

# Serve WebP for JPEG if possible
RewriteCond %{HTTP:Accept} image/webp
RewriteCond %{DOCUMENT_ROOT}/$1\.webp -s
RewriteRule (.+)\.jpg$ $1.webp

<FilesMatch "\.jpg$">
	Header append Vary Accept
</FilesMatch>

# Cache management
ExpiresActive On
ExpiresByType text/html "access plus 5 minutes"

# Cache cachebusted content virtually forever
<If "%{QUERY_STRING} =~ /^[^=]{8}$/">
	# CSS and JavaScript
	ExpiresByType application/javascript "access plus 1 year"
	ExpiresByType image/jpeg "access plus 1 year"
	ExpiresByType image/webp "access plus 1 year"
	ExpiresByType text/css "access plus 1 year"
	ExpiresByType image/x-icon "access plus 1 year"

	# Default
	ExpiresDefault "access plus 1 year"
</If>
<Else>
	# CSS and JavaScript
	ExpiresByType application/javascript "access plus 10 minutes"
	ExpiresByType image/jpeg "access plus 10 minutes"
	ExpiresByType image/webp "access plus 10 minutes"
	ExpiresByType text/css "access plus 10 minutes"
	ExpiresByType image/x-icon "access plus 1 hour"

	# Default
	ExpiresDefault "access plus 5 minutes"
</Else>
