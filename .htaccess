Options -Includes
RewriteEngine On

# Rewrite HTTP to HTTPS
RewriteCond %{SERVER_PORT} 80
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Security headers
Header set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" env=HTTPS
Header set X-Frame-Options DENY

# Serve WebP for JPEG if possible
RewriteCond %{HTTP:Accept} image/webp
RewriteCond %{DOCUMENT_ROOT}/$1\.webp -s
RewriteRule (.+)\.jpg$ $1.webp

<FilesMatch "\.jpg$">
	Header append Vary Accept
</FilesMatch>

# Cache management
ExpiresActive On
ExpiresByType text/html "access plus 5 minutes"

# Cache cachebusted content virtually forever
<If "%{QUERY_STRING} =~ /^[^=]{8}$/">
	# CSS and JavaScript
	ExpiresByType application/javascript "access plus 1 year"
	ExpiresByType image/jpeg "access plus 1 year"
	ExpiresByType image/webp "access plus 1 year"
	ExpiresByType text/css "access plus 1 year"
	ExpiresByType image/x-icon "access plus 1 year"

	# Default
	ExpiresDefault "access plus 1 year"
</If>
<Else>
	# CSS and JavaScript
	ExpiresByType application/javascript "access plus 10 minutes"
	ExpiresByType image/jpeg "access plus 10 minutes"
	ExpiresByType image/webp "access plus 10 minutes"
	ExpiresByType text/css "access plus 10 minutes"
	ExpiresByType image/x-icon "access plus 1 hour"

	# Default
	ExpiresDefault "access plus 5 minutes"
</Else>
